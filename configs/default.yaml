# ReID Research Module Configuration
model:
  reid_variant: "osnet_x1_0"       # osnet_x1_0 (validated: best accuracy)
  reid_weights: null               # null = auto-download pretrained
  yolo_weights: "data/weights/jointbdoe_m.pt"  # JointBDOE-M (same as sauron-services)
  detector_type: "jointbdoe"       # "yolo" or "jointbdoe"
  device: "cuda"                   # cuda (validated)
  # FastReID configuration (SBS R50-ibn: 89.3% mAP, 2048-dim features)
  use_fastreid: false              # Toggle FastReID vs OSNet
  fastreid_config: "fast-reid/configs/Market1501/market_sbs_R50-ibn.yml"
  fastreid_weights: "weights/market_sbs_R50-ibn.pth"
  fastreid_input_size: [384, 128]  # H, W

inference:
  image_size: [512, 256]           # ReID crop size (H, W)
  batch_size: 32                   # Feature extraction batch
  confidence_threshold: 0.6        # YOLO detection confidence
  similarity_threshold: 0.8        # ReID cosine similarity (stricter to prevent ID theft)

gallery:
  max_features_per_id: 200         # Rolling window size
  ema_alpha: 0.6                   # Feature update weight

  # Rank-list majority voting (triplet-loss style)
  rank_list_size: 20               # Top-k entries in rank list
  rank_distance_threshold: 1.0     # Fixed threshold for voting
  rank_min_entries_per_id: 2       # Min features before voting kicks in
  rank_fallback_threshold: 2.0     # Distance threshold for matching (max for L2-normalized)

  # Simplified k-reciprocal re-ranking (+3-5% mAP)
  use_reranking: false             # Simplified boost (superseded by full reranking)
  rerank_k: 10                     # Neighbors for reciprocal check
  rerank_boost: 0.2                # Similarity boost for matches

  # Full k-reciprocal with Jaccard distance (CVPR 2017, +5-15% accuracy)
  use_full_reranking: true         # Full algorithm (recommended)
  rerank_k1: 10                    # Initial k for R(p,k1)
  rerank_k2: 5                     # Expansion k for R*(p,k1)
  rerank_lambda: 0.3               # Weight for original distance

  # Quality-aware feature fusion (+2-3% in occlusion)
  use_quality_weighting: true      # Weight features by detection quality
  quality_min_threshold: 0.3       # Skip updates below this
  quality_confidence_weight: 0.6   # Weight for detection confidence
  quality_geometry_weight: 0.4     # Weight for bbox geometry
  ideal_aspect_ratio: 0.4          # Typical person W/H ratio
  min_bbox_area: 1000              # Minimum pixels for valid detection

  # Velocity-based temporal consistency (-15-30% ID switches)
  use_velocity_prediction: true    # Motion prediction (recommended)
  velocity_history_frames: 5       # Frames to average velocity
  velocity_max_speed: 100.0        # Max pixels/frame (clamp outliers)
  prediction_radius: 75.0          # Match radius around prediction
  prediction_boost: 0.01           # Reduced to prevent ID theft when people cross paths

  # Tentative track confirmation (prevents spurious IDs)
  min_frames_for_id: 5             # Min consecutive frames before permanent ID
  tentative_max_age: 10            # Max frames to keep unconfirmed tentative track

  # Legacy temporal consistency (deprecated - use velocity_prediction)
  use_temporal_consistency: false  # Position-hash based (legacy)
  temporal_window: 5               # Frames to track history
  temporal_boost: 0.2              # Boost for consistent matches

  # Adaptive similarity threshold (-10-20% false positives)
  use_adaptive_threshold: true    # Dynamic threshold adjustment
  adaptive_min_threshold: 0.50     # Floor threshold
  adaptive_max_threshold: 0.80     # Ceiling threshold
  adaptive_window_size: 100        # Matches to track
  adaptive_target_percentile: 0.15 # Target false positive rate
  adaptive_warmup_matches: 20      # Minimum matches before adapting

output:
  save_video: true
  save_tracks: true                # JSON track export
  visualization: true              # Draw boxes + IDs

visualization:
  # Layout
  gallery_panel_width: 200         # Width of gallery side panel in pixels
  gallery_panel_position: "right"  # "left" or "right"
  show_gallery_panel: true         # Show person thumbnails panel
  show_pipeline_hud: true          # Show pipeline stage indicator
  max_gallery_entries: 10          # Most recent entries to display

  # Colors and styling
  panel_bg_opacity: 0.75           # Background opacity for overlays
  bbox_thickness_matched: 3        # Line thickness for ReID matches
  bbox_thickness_unmatched: 2      # Line thickness for new detections

  # Split view (educational mode)
  split_view_enabled: false       # Disabled - show ReID view only
  split_view_stages: ["detection", "reid"]

  # Extended frame layout (analytics outside video frame)
  extended_frame_enabled: true    # Stats/gallery in padding, ID matching at bottom
